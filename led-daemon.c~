#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <time.h>
#include <sys/types.h>
#include <signal.h>

#define LED_CMD "/usr/local/bin/ledctl"
#define SLEEP_INTERVAL 300  // 5分钟

void handle_signal(int sig) {
    printf("收到信号 %d，准备退出...\n", sig);
    exit(0);
}

int main() {
    signal(SIGINT, handle_signal);
    signal(SIGTERM, handle_signal);

    printf("启动led-daemon...\n");

    while (1) {
        time_t now = time(NULL);
        struct tm *tm_now = localtime(&now);
        int hour = tm_now->tm_hour;

        if (hour >= 22 || hour < 8) {
            // 关闭灯
            char cmd[256];
            snprintf(cmd, sizeof(cmd), "%s off", LED_CMD);
            system(cmd);
        } else {
            // 打开灯
            char cmd[256];
            snprintf(cmd, sizeof(cmd), "%s on", LED_CMD);
            system(cmd);
        }

        sleep(SLEEP_INTERVAL);
    }

    return 0;
}
